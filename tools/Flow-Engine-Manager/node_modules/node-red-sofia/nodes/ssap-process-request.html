<html>
    <div style="display: none;" id="dialog-error" title="Se ha producido un error">Se ha perdido la comunicación con la plataforma</div>    

    <script type="text/javascript" language="javascript" src="config/sofia2-config.js"></script>
	<script type="text/javascript">

		
		RED.nodes.registerType('ssap-process-request',{
			category: 'input',
			color: '#C0DEED',
			defaults: {
				name: {value:""},
				direccion: {value:""},
				tipomensaje: {value:""},
				ontology: {value:""},
				thinKp : {value:""},
				instanciakp: {value:""},
			},
			inputs: 0,
			outputs:2,
			icon: "input.png",
			label: function() {
				return this.name||"ssap-process-request";
			}

		});
     
 


     function showErrorDialogSsap() {
            $( "#dialog-error" ).dialog({
              resizable: false,
              modal: true,
              position: [($(window).width() / 2) - 150, 160],
              dialogClass: 'DeleteConfirmDialog',
               buttons: {
		            'OK': function () {
		                $(this).dialog("close");
		                return true;
		            }
		        }
            });
          }


     var listaOntologiasUsuario;
     var insertedLista = false;
     var listaKpUsuario;
     var insertedListaKp = false;


     function onElementInserted(containerSelector, elementSelector, callback) {

		    var onMutationsObserved = function(mutations) {
		        mutations.forEach(function(mutation) {
		            if (mutation.addedNodes.length) {
		                var elements = $(mutation.addedNodes).find(elementSelector);
		                for (var i = 0, len = elements.length; i < len; i++) {
		                    callback(elements[i]);
		                }
		            }
		        });
		    };

		    var target = $(containerSelector)[0];
		    var config = { childList: true, subtree: true };
		    var MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
		    var observer = new MutationObserver(onMutationsObserved);    
		    observer.observe(target, config);

	}

     function getParameterByName(name, url) {
		    if (!url) {
		      url = window.location.href;
		    }
		    name = name.replace(/[\[\]]/g, "\\$&");
		    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		        results = regex.exec(url);
		    if (!results) return null;
		    if (!results[2]) return '';
		    return decodeURIComponent(results[2].replace(/\+/g, " "));
		}


     var user = getParameterByName('usuario');
	var password = getParameterByName('password');
      


	 var auth = getParameterByName('authentication');
     function obtenerDataUsuario(){

             
             var urlService = sofia2Config.scriptBasePath +'/sofia2/flowengine/node/services/user/all_data?authentication=';

             var url = urlService + auth;


             $.ajax({
                url:    url , 
                dataType: "jsonp",
                timeout: 5000, 
                jsonpCallback: 'dataAllUser',
               success: function(data, textStatus, jqXHR) {
                  	
                    if(textStatus == "success"){
                       
                       
                       listaOntologiasUsuario = data.toString().split("##$$##")[0];
                       listaOntologiasUsuario = listaOntologiasUsuario.split(",");
                       listaOntologiasUsuario.splice(listaOntologiasUsuario.length-1, listaOntologiasUsuario.length);
                       listaKpUsuario = data.toString().split("##$$##")[1];
                       listaKpUsuario = listaKpUsuario.split(",");
                       listaKpUsuario.splice(0,1);

                       onElementInserted('body', '#node-input-thinKpSsap', function(element) {
                            

                 while(insertedListaKp == false){ 
                 	     $('#node-input-thinKpSsap').append('<option value='+""+'>'+
                 	     	" "+'</option>');
                        $.each(listaKpUsuario, function (i, item) {
                                    $('#node-input-thinKpSsap').append('<option value='+item+'>'+item+'</option>');
                                });

                         
                      insertedListaKp = true; 
                  }

			

                  if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
                  	 $('#node-input-thinKpSsap').val( $('#node-input-thinKp').val());
                  }
                  
                  $('#node-input-thinKpSsap').change(function(){
                  

                  	$('input[name=selectThinKpSsap]').val( $('#node-input-thinKpSsap').val());

                    if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSsap').val()){
				  	    $('#node-input-thinKp').val($('#node-input-thinKpSsap').val());		
				  	}
				  			
                   }); 
                  
                  
               
          });   

          onElementInserted('body', '#node-input-ontologySsap', function(element) {
                 

                 while(insertedLista == false){ 
                 	     $('#node-input-ontologySsap').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaOntologiasUsuario, function (i, item) {
                                    $('#node-input-ontologySsap').append('<option value='+item+'>'+item+'</option>');
                                });

                        
                      insertedLista = true; 
                  }

              

                  if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
                  	 $('#node-input-ontologySsap').val( $('#node-input-ontology').val());
                  }
                 

				  $('#node-input-ontologySsap').change(function(){
				  	
				  	$('input[name=selectOntologySsap]').val( $('#node-input-ontologySsap').val());
				  	
				  	if($('#node-input-ontology').val() !=  $('#node-input-ontologySsap').val()){
				  	    $('#node-input-ontology').val($('#node-input-ontologySsap').val());		
				  	}
				  	


				  }); 
                  
                
                  
               
          });   


                    }
                    

             }
             , error: function(xhr, status, error) {

                  
                   
                  if(listaOntologiasUsuario!=null && listaKpUsuario!=null){

                      //Cargamos las listas en los combos
                      onElementInserted('body', '#node-input-thinKpSsap', function(element) {
                            

		                 while(insertedListaKp == false){ 
		                 	     $('#node-input-thinKpSsap').append('<option value='+""+'>'+
		                 	     	" "+'</option>');
		                        $.each(listaKpUsuario, function (i, item) {
		                                    $('#node-input-thinKpSsap').append('<option value='+item+'>'+item+'</option>');
		                                });

		                         
		                      insertedListaKp = true; 
		                  }

					

		                  if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
		                  	 $('#node-input-thinKpSsap').val( $('#node-input-thinKp').val());
		                  }
		                  
		                  $('#node-input-thinKpSsap').change(function(){
		                  

		                  	$('input[name=selectThinKpSsap]').val( $('#node-input-thinKpSsap').val());

		                    if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSsap').val()){
						  	    $('#node-input-thinKp').val($('#node-input-thinKpSsap').val());		
						  	}
						  			
		                   }); 
		                  
                  
               
         			 });   

         			 onElementInserted('body', '#node-input-ontologySsap', function(element) {
                 

               			 while(insertedLista == false){ 
	                 	     $('#node-input-ontologySsap').append('<option value='+""+'>'+""+'</option>');
	                        $.each(listaOntologiasUsuario, function (i, item) {
	                                    $('#node-input-ontologySsap').append('<option value='+item+'>'+item+'</option>');
	                                });

	                        
	                      insertedLista = true; 
	                  }

              

                  if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
	                  	 $('#node-input-ontologySsap').val( $('#node-input-ontology').val());
	                  }
	                 

					  $('#node-input-ontologySsap').change(function(){
					  	
					  	$('input[name=selectOntologySsap]').val( $('#node-input-ontologySsap').val());
					  	
					  	if($('#node-input-ontology').val() !=  $('#node-input-ontologySsap').val()){
					  	    $('#node-input-ontology').val($('#node-input-ontologySsap').val());		
					  	}
					  	


					  }); 
	           
          				}); 

                }else{
                	   showErrorDialogSsap();
                }
              } 



            })

       }


      //llamada a obtener los datos del usuario.
      obtenerDataUsuario(); 
      

	</script>

  
	<script type="text/x-red" data-template-name="ssap-process-request">

	    


		<div class="form-row">
			<label for="node-input-name"><i class="icon-tag"></i> Name</label>
			<input type="text" id="node-input-name" placeholder="Name">
		</div>
		<div class="form-row">
			<label for="node-input-direccion"><i class=" icon-share-alt"></i>Message address</label>
			<select id="node-input-direccion" placeholder="Dirección mensaje">
				<option value="input"> INPUT</option>
				<option value="output"> OUTPUT</option>
			</select>
		</div>
		<div class="form-row">
			<label for="node-input-tipomensaje"><i class="icon-th-list"></i> Type message</label>
			<select id="node-input-tipomensaje" placeholder="Tipo mensaje">
				<option value="insert"> INSERT</option>
				<option value="query"> QUERY</option>
				<option value="update"> UPDATE</option>
				<option value="remove"> REMOVE</option>
			</select>
		</div>

        <div class="form-row">
			<label for="node-input-ontologySsap"><i class="icon-th-list"></i>Ontologies available </label>
			<select id="node-input-ontologySsap" placeholder="Ontology">
				
			</select>
		</div>
   
      <div class="form-row">
			<label for="node-input-ontology"><i class="icon-tag"></i> Ontology</label>
			<input  disabled="disabled" type="text" id="node-input-ontology" placeholder="Ontology">
		</div>
		
		 <div class="form-row">
            <label for="node-input-thinKpSsap"><i class="icon-th-list"></i>ThinKP avalaible</label>
            <select id="node-input-thinKpSsap" placeholder="ThinKP">
                
            </select>
        </div>

         <div class="form-row">
			<label for="node-input-thinKp"><i class="icon-tag"></i> ThinKP</label>
			<input  disabled="disabled" type="text" id="node-input-thinKp" placeholder="ThinKP">
		</div>
		<div class="form-row">
			<label for="node-input-instanciakp"><i class="icon-file"></i> KP instance</label>
			<input type="text" id="node-input-instanciakp" placeholder="Instancia KP">
		</div>

        
          <input type="hidden" name="selectOntologySsap" value="">
          <input type="hidden" name="selectThinKpSsap" value="">	

		 <script type="text/javascript">
        	
          var insertedLista = false;
          var insertedListaKp = false;
          
 		onElementInserted('body', '#node-input-thinKpSsap', function(element) {
                            

                 while(insertedListaKp == false){ 
                 	     $('#node-input-thinKpSsap').append('<option value='+""+'>'+
                 	     	" "+'</option>');
                        $.each(listaKpUsuario, function (i, item) {
                                    $('#node-input-thinKpSsap').append('<option value='+item+'>'+item+'</option>');
                                });

                         
                      insertedListaKp = true; 
                  }

			

                  if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
                  	 $('#node-input-thinKpSsap').val( $('#node-input-thinKp').val());
                  }
                  
                  $('#node-input-thinKpSsap').change(function(){
                  

                  	$('input[name=selectThinKpSsap]').val( $('#node-input-thinKpSsap').val());

                    if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSsap').val()){
				  	    $('#node-input-thinKp').val($('#node-input-thinKpSsap').val());		
				  	}
				  			
                   }); 
                  
                  
               
          });   

          onElementInserted('body', '#node-input-ontologySsap', function(element) {
                 

                 while(insertedLista == false){ 
                 	     $('#node-input-ontologySsap').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaOntologiasUsuario, function (i, item) {
                                    $('#node-input-ontologySsap').append('<option value='+item+'>'+item+'</option>');
                                });

                        
                      insertedLista = true; 
                  }

              

                  if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
                  	 $('#node-input-ontologySsap').val( $('#node-input-ontology').val());
                  }
                 

				  $('#node-input-ontologySsap').change(function(){
				  	
				  	$('input[name=selectOntologySsap]').val( $('#node-input-ontologySsap').val());
				  	
				  	if($('#node-input-ontology').val() !=  $('#node-input-ontologySsap').val()){
				  	    $('#node-input-ontology').val($('#node-input-ontologySsap').val());		
				  	}
				  	


				  }); 
                  
                
                  
               
          });   

		</script>

	</script>

	<script type="text/x-red" data-help-name="ssap-process-request">
		<p>Node receiving messages SSAP type, entering or leaving the SIB of Sofia2</p>
		<p><code>Name</code> It is used to identity the node SSAP by a specific name. 
		This is an optional field.</p>

	    <p><code>Message address</code> Indicates the address of the message, input or output.
	    </p>
	    <p><code>Type message</code> Selection of different types of messages you can receive, send the node.
	    </p>
	    <p><code>Ontology</code> Name of the ontology to be referenced. It represents the domain model that handles a Thing.
	    </p>
	    <p><code>ThinKPs</code> It is used to indicate the KP to be referenced.
	    </p>
	    <p> A Thing (terminology sofia2 talk about KP: Knowledge Processor) represents each of the elements that interact with the platform, either by publishing either consuming information.
		</p>

		<p> A Thing can represent from a simple device (an Arduino or iBeacon) to a Gateway (one Raspberry) or an Enterprise System (Java Backend).</p>	

	    <p><code>KP instance</code> It is used to indicate the  KP instance to be referenced.
	    </p>

	</script>
	
	
	<script language ="javascript" type = "text/javascript" >

 
    
         
      </script>
</html>
