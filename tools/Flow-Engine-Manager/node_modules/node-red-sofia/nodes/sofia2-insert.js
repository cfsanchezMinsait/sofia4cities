module.exports = function(RED) {
    var Client = require('node-rest-client').Client;
    var sofia2Config = require('./config/sofia2-config');
    var ontology = "";
    var authentication ="";

        console.log("DELETEME - N RED: " + JSON.stringify(RED));
    function SubmitInsert(n) {
        RED.nodes.createNode(this,n);
        var node = this;
        var client = new Client();
        console.log("DELETEME - N RED: " + JSON.stringify(n));
        this.query=n.query;
        this.query = this.query.replace(/ /g, "+");
        ontology = n.ontology;
        authentication = n.authentication;
        
        var args = {
            requesConfig: { timeout: 1000 },
            responseConfig: { timeout: 2000 }
        };
        
        this.on('input', function(msg) {
            var endpoint = sofia2Config.scriptBasePath + "/sofia2/flowengine/node/services/user/insert?ontology=" + ontology + "&data=" + msg.payload + "&authentication=" + n.authentication;
            console.log("DELETEME - INSERTING:" + endpoint);
            var req = client.get(endpoint, args,function (data, response) {
                // parsed response body as js object 
                console.log("statusCode: ", response.statusCode);
                if(response.statusCode== 200){
                    msg.ok=true;
                }else{
                    msg.ok=false;
                }
                msg.payload=data;
                msg=JSON.stringify(msg);
                msg = JSON.parse(msg);
                node.send(msg);
            });
            req.on('requestTimeout', function (req) {
                msg.ok=false;
                console.log("request has expired");
                req.abort();
            });
             
            req.on('responseTimeout', function (res) {
                msg.ok=false;
                console.log("response has expired");
            });
            
        });
        
         
    }
     RED.nodes.registerType("sofia2-insert",SubmitInsert);

}