<html>
    <head>
        <title>Chat WebSocket</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="./sofia_ws_api.js"></script>
        <script type="text/javascript">
            
			config = {"url":"http://localhost:8081/iotbroker/message", "debug" : true,
					  "token":"f45ae34dd65e478983d2ffad6e4f4237", "clientPlatform": "GTKP-Example", "clientPlatformInstance":"kp01"};
					  
			client = new SofiaClient();
			client.configure(config);
			
			client.connect().then(function(val) {
				console.log("logged");
			});
			
			function connectTestMulti(){
				
				i=0;
				while (i< 100){
					if (i%2 == 0){
						/*client.join(function (response) {
							console.log("" + JSON.stringify(response));
						});*/
						client.join().then(function (response){
							console.log("par -> " + JSON.stringify(response));
						});
					}else{
						/*client.join(function (response) {
							console.log("impar -> " + JSON.stringify(response));
						});
						*/
						client.join().then(function (response){
							console.log("imppar -> " + JSON.stringify(response));
						});
					}
					
					i++;
				}
			}
			
			function writeResult(operation , result){
				console.log(operation);
				console.log(result);
				content =  "<p>" + operation + "</p>" + "<pre>" + JSON.stringify(result,null,'\t') + "</pre>";
				$("#responseDivResult").html(content);
			}
			
			function connectTest(){
						client.join().then(function (response){
							writeResult("response join ", response);
						});
			}
			
			function sendQueryTest(){
				var ontology = $("#ontology").val();
				var query = $("#query").val();
				var queryType = "NATIVE";
				
				client.query(ontology, query, queryType).then(function (response){
					content = "response query num of items ";
					if (response.body !=null && response.body.data != null){
						content += response.body.data.length;
					} else {content += "0";}
					
					writeResult(content, response);					
				});

			}
			
			function sendInsertTest () {
				var ontology = $("#ontology").val();
				var query = $("#query").val();
				
				//data = {"EmptyBase" : { "test" : "3" } };
				
				data = JSON.parse($("#insertInstance").val());
				
				client.insert(ontology, JSON.stringify(data)).then(function (response) {
					writeResult("response insert ", response);
				});	
			}
			
			function sendUpdate () {
				var ontology = $("#ontology").val();
				var query = $("#query").val();
				
				client.update(ontology, query).then(function (response){
					writeResult("response update", response);
				});
				
			}
			
			function sendRemoveTest(){
				var ontology = $("#ontology").val();
				var query = $("#query").val();
				client.remove(ontology, query).then(function (response){
					writeResult("test remove", response);
				});
			}
			
			function sendUpdateByIdTest(){
				var ontology = $("#ontology").val();
				var sofiaId = $("#sofiaId").val();
				
				data = {"EmptyBase" : { "test" : "testupdate3" } };
				
				client.updateById(ontology, sofiaId, JSON.stringify(data)).then( function (response){
					writeResult("test updateById ", response);
				});
			}
			
			function sendRemoveByIdTest(){
				var ontology = $("#ontology").val();
				var sofiaId = $("#sofiaId").val();
				
				client.removeById(ontology, sofiaId).then( function (response){
					writeResult("test remove byId ", response);
				});
			}
			
			

        </script>
    </head>
    <body >
        <div>
            <br />
            <div>
                <button id="connect" onclick="connectTest();">Connect</button>
				<button id="connect" onclick="connectTestMulti();">Connect Multi</button>
				
                <button id="disconnect" disabled="disabled" onclick="disconnect();">
                    Disconnect
                </button>
            </div>
            <br />
			<div>
				Ontology name: <input type="text" id="ontology" placeholder="write ontology..." value="testrober"/>
			</div>
			<br/>
            <div id="conversationDiv">
                Query: <input type="text" id="query" placeholder="Write a query..." value="db.testrober.find()"/>
                <button id="sendMessage" onclick="sendQueryTest()">Test query</button>			
				<button id="sendMessageUpdate" onclick="sendUpdate()">Test update</button>				
				<button id="sendMessageDelete" onclick="sendRemoveTest()">Test delete</button>
                <p id="response"></p>
            </div>
			<br/>
			<div>
				<input type="text" id="insertInstance" placeholder="Write instance to insert..." value="{'EmptyBase' : { 'test' : '3' } }"/>
				<button id="sendInserMessage" onclick="sendInsertTest()">Test insert query</button>	
			</div>
			<br/>
			<div>
				Id <input type="text" id="sofiaId" placeholder="write id..."/>
				<button id="sendMessageUpdate" onclick="sendUpdateByIdTest()">Test updateById</button>
				<button id="sendMessageDelete" onclick="sendRemoveByIdTest()">Test deleteById</button>
			</div>
			
			<div id= "responseDivResult"></div>
        </div>
 
    </body>
</html>